<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Redirect Admin — Dark</title>
<style>
  :root{
    --bg:#0b0f14; --card:#0f1720; --muted:#9aa7b2; --accent:#7c5cff; --danger:#ff5c7c; --text:#e6eef6;
  }
  body{background:linear-gradient(180deg,#061017 0%, #08141a 100%);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  .wrap{max-width:1100px;margin:28px auto;padding:18px;}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
  h1{margin:0;font-weight:600}
  .card{background:var(--card);padding:14px;border-radius:8px;margin-bottom:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}
  input,button,textarea{font-size:14px;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#071018;color:var(--text);width:100%}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .muted{color:var(--muted);font-size:13px}
  .btn{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn.danger{background:var(--danger)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
  .small{font-size:12px;color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center}
  .center{display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>Redirect Admin (Dark)</h1>
      <div class="muted">Manage redirects · generate links · view click analytics</div>
    </div>
  </div>

  <div id="app">
    <div class="card">
      <div class="row">
        <div class="col">
          <label class="small">Destination URL</label>
          <input id="destUrl" placeholder="https://example.com/page" />
        </div>
        <div style="width:200px">
          <label class="small"> </label>
          <button id="genBtn" class="btn" style="width:100%">Generate</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Generated redirect will be auto-saved locally.</div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Redirects</h3>
      <div id="redirectsArea" class="small muted">Loading…</div>
      <table id="redirectsTable" style="display:none">
        <thead><tr><th>Short URL</th><th>Destination</th><th>Actions</th></tr></thead>
        <tbody id="redirectsBody"></tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Analytics (last 200 clicks)</h3>
      <div id="analyticsArea" class="small muted">Loading…</div>
      <table id="analyticsTable" style="display:none">
        <thead><tr><th>Time</th><th>Slug</th><th>Country</th><th>User-Agent</th></tr></thead>
        <tbody id="analyticsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import fs from 'fs';
import path from 'path';

// Local files
const redirectsPath = path.resolve('./data/redirects.json');
const analyticsPath = path.resolve('./data/analytics.json');

// Subdomains
const subdomains = ["gd2","yrn","8jr"];
function pickSubdomain(slug) {
  let hash=0;
  for(let i=0;i<slug.length;i++){hash=(hash<<5)-hash+slug.charCodeAt(i);hash|=0;}
  return subdomains[Math.abs(hash)%subdomains.length];
}

// Elements
const destInput = document.getElementById('destUrl');
const genBtn = document.getElementById('genBtn');
const redirectsBody = document.getElementById('redirectsBody');
const redirectsArea = document.getElementById('redirectsArea');
const redirectsTable = document.getElementById('redirectsTable');
const analyticsBody = document.getElementById('analyticsBody');
const analyticsArea = document.getElementById('analyticsArea');
const analyticsTable = document.getElementById('analyticsTable');

// Load redirects
function loadRedirects() {
  let redirects = [];
  try {
    redirects = JSON.parse(fs.readFileSync(redirectsPath,'utf-8'));
  } catch{}
  redirectsBody.innerHTML='';
  redirects.slice().reverse().forEach(e=>{
    const slug=e.slug;
    const dest=e.destination;
    const sub=e.subdomain||'gd2';
    const domain=window.location.hostname.split('.').slice(-2).join('.');
    const shortUrl=`https://${sub}.${domain}/${slug}`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="max-width:320px;word-break:break-all"><a href="${shortUrl}" target="_blank">${shortUrl}</a></td>
                    <td style="max-width:420px;word-break:break-all">${dest}</td>
                    <td class="flex">
                      <button data-slug="${slug}" class="btn" style="padding:6px 8px">Copy</button>
                      <button data-slug="${slug}" class="btn danger" style="padding:6px 8px">Delete</button>
                    </td>`;
    redirectsBody.appendChild(tr);
  });
  redirectsArea.innerText=`${redirects.length} redirect(s)`;
  redirectsTable.style.display=redirects.length?'':'none';

  document.querySelectorAll('button[data-slug]').forEach(btn=>{
    btn.onclick=ev=>{
      const s=ev.currentTarget.getAttribute('data-slug');
      if(ev.currentTarget.classList.contains('danger')){
        if(!confirm('Delete this redirect?')) return;
        let redirectsDel=[];
        try{redirectsDel=JSON.parse(fs.readFileSync(redirectsPath,'utf-8'))}catch{}
        redirectsDel=redirectsDel.filter(r=>r.slug!==s);
        fs.writeFileSync(redirectsPath,JSON.stringify(redirectsDel,null,2),'utf-8');
        loadRedirects();
        loadAnalytics();
        return;
      }
      // Copy
      let redirectsCopy=[];
      try{redirectsCopy=JSON.parse(fs.readFileSync(redirectsPath,'utf-8'))}catch{}
      const eObj=redirectsCopy.find(r=>r.slug===s);
      const url=`https://${eObj.subdomain||"gd2"}.${window.location.hostname.split(".").slice(-2).join(".")}/${s}`;
      navigator.clipboard.writeText(url);
      alert('Copied: '+url);
    };
  });
}

// Load analytics
function loadAnalytics(){
  let rows=[];
  try{rows=JSON.parse(fs.readFileSync(analyticsPath,'utf-8'))}catch{}
  analyticsBody.innerHTML='';
  rows.slice(-200).reverse().forEach(rec=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date(rec.timestamp).toLocaleString()}</td>
                    <td style="max-width:220px;word-break:break-all">${rec.slug}</td>
                    <td>${rec.country||'XX'}</td>
                    <td style="max-width:420px;word-break:break-all">${rec.ua||''}</td>`;
    analyticsBody.appendChild(tr);
  });
  analyticsArea.innerText=`${rows.length} clicks recorded`;
  analyticsTable.style.display=rows.length?'':'none';
}

// Generate redirect locally
genBtn.onclick=()=>{
  const destination=destInput.value.trim();
  if(!destination) return alert('Enter destination URL');
  const slug=Math.random().toString(36).substring(2,8);
  const subdomain=pickSubdomain(slug);

  let redirects=[];
  try{redirects=JSON.parse(fs.readFileSync(redirectsPath,'utf-8'))}catch{}
  redirects.push({slug,destination,subdomain});
  fs.writeFileSync(redirectsPath,JSON.stringify(redirects,null,2),'utf-8');
  alert('✅ Redirect saved locally!\nSlug: '+slug);
  destInput.value='';
  loadRedirects();
};

// Initialize
loadRedirects();
loadAnalytics();

</script>
</body>
</html>
